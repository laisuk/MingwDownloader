name: CI (MSVC, windows-latest)

on:
  workflow_dispatch:

jobs:
  build-msvc:
    runs-on: windows-latest

    env:
      BUILD_TYPE: Release
      VCPKG_TRIPLET: x64-windows-static
      VCPKG_WDIR: ${{ github.workspace }}\vcpkg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$env:VCPKG_WDIR"
          cmd /c """$env:VCPKG_WDIR\bootstrap-vcpkg.bat"""

      - name: Cache vcpkg artifacts
        uses: actions/cache@v4
        with:
          path: |
            vcpkg\downloads
            vcpkg\buildtrees
            vcpkg\packages
            vcpkg\installed
            C:\Users\runneradmin\AppData\Local\vcpkg\archives
          key: vcpkg-${{ runner.os }}-${{ env.VCPKG_TRIPLET }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install dependencies (vcpkg)
        shell: pwsh
        run: |
          $vcpkgRoot = "$env:VCPKG_WDIR"
          $vcpkg = "$vcpkgRoot\vcpkg.exe"

          & $vcpkg --vcpkg-root $vcpkgRoot install `
            "fltk[core,opengl]" `
            "curl[core,non-http,sspi,ssl]" `
            "libarchive[core,lzma]" `
            --triplet $env:VCPKG_TRIPLET `
            --host-triplet x64-windows

      - name: Configure (CMake)
        shell: pwsh
        run: |
          $vcpkgRoot = "$env:GITHUB_WORKSPACE\vcpkg"
          $trip = "$env:VCPKG_TRIPLET"

          cmake -S . -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
            -DCMAKE_TOOLCHAIN_FILE="$vcpkgRoot\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=$trip `
            -DVCPKG_INSTALLED_DIR="$vcpkgRoot\installed" `
            -DFLTK_DIR="$vcpkgRoot\installed\$trip\share\fltk"

      - name: Build
        shell: pwsh
        run: |
          cmake --build build --config $env:BUILD_TYPE

      - name: Upload artifact (exe)
        uses: actions/upload-artifact@v4
        with:
          name: MingwDownloader-${{ runner.os }}-${{ env.VCPKG_TRIPLET }}
          path: |
            build/MingwDownloader.exe
            build/Release/MingwDownloader.exe
          if-no-files-found: error