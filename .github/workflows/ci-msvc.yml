name: CI (MSVC, windows-latest)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  workflow_dispatch:

jobs:
  build-msvc:
    runs-on: windows-latest

    env:
      BUILD_TYPE: Release
      VCPKG_TRIPLET: x64-windows-static

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$env:GITHUB_WORKSPACE\vcpkg"
          cd "$env:GITHUB_WORKSPACE\vcpkg"
          .\bootstrap-vcpkg.bat

      - name: Cache vcpkg artifacts
        uses: actions/cache@v4
        with:
          path: |
            vcpkg\downloads
            vcpkg\buildtrees
            vcpkg\packages
            vcpkg\installed
          key: vcpkg-${{ runner.os }}-${{ env.VCPKG_TRIPLET }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ env.VCPKG_TRIPLET }}-

      - name: Install dependencies (vcpkg)
        shell: pwsh
        run: |
          $vcpkg = "$env:GITHUB_WORKSPACE\vcpkg\vcpkg.exe"
          & $vcpkg install fltk curl libarchive --triplet $env:VCPKG_TRIPLET

      - name: Configure (CMake)
        shell: pwsh
        run: |
          # Your CMakeLists uses VCPKG_ROOT if present
          $env:VCPKG_ROOT = "$env:GITHUB_WORKSPACE\vcpkg"

          cmake -S . -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
            -DVCPKG_TARGET_TRIPLET=$env:VCPKG_TRIPLET

      - name: Build
        shell: pwsh
        run: |
          cmake --build build --config $env:BUILD_TYPE

      - name: Upload artifact (exe)
        uses: actions/upload-artifact@v4
        with:
          name: MingwDownloader-${{ runner.os }}-${{ env.VCPKG_TRIPLET }}
          path: |
            build/MingwDownloader.exe
            build/Release/MingwDownloader.exe
          if-no-files-found: error